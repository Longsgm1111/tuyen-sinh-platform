<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>

<!-- Quill Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<link rel="stylesheet" href="style.css">
<style>
body { background:#f4f6f9; color:#333; }

.admin-container {
  display:flex;
  height:100vh;
}

.sidebar {
  width:250px;
  background:#1e3c72;
  color:white;
  padding:20px;
  overflow-y:auto;
}

.sidebar h3 {
  margin-top:0;
}

.sidebar button {
  width:100%;
  margin-bottom:10px;
  padding:10px;
  border:none;
  cursor:pointer;
  background:white;
  color:#1e3c72;
  border-radius:5px;
}

.main-panel {
  flex:1;
  padding:20px;
  display:flex;
  flex-direction:column;
}

.editor-area {
  flex:1;
  background:white;
  border-radius:8px;
  overflow:hidden;
}

#editor {
  height:300px;
}

.preview {
  flex:1;
  background:white;
  margin-top:20px;
  padding:15px;
  border-radius:8px;
  overflow:auto;
}

.topbar {
  display:flex;
  justify-content:space-between;
  margin-bottom:10px;
}

.upload-section {
  margin-top:10px;
}
</style>
</head>
<body>

<div class="admin-container">

  <div class="sidebar">
    <h3>Danh m·ª•c</h3>
    <div id="tabList"></div>
    <button onclick="save()">üíæ L∆∞u thay ƒë·ªïi</button>
    <button onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
  </div>

  <div class="main-panel">
    <div class="topbar">
      <h2 id="currentTab">Ch·ªçn m·ª•c</h2>
    </div>

    <div class="editor-area">
      <div id="editor"></div>
    </div>

    <div class="upload-section">
      <input type="file" id="imageUpload">
      <input type="text" id="driveLink" placeholder="D√°n link ·∫£nh Google Drive t·∫°i ƒë√¢y">
      <button onclick="insertDriveImage()">Ch√®n ·∫£nh t·ª´ Drive</button>
    </div>

    <div class="preview">
      <h3>Preview</h3>
      <div id="previewContent"></div>
    </div>
  </div>

</div>

<script>
let dbData = null;
let currentTab = null;

const quill = new Quill('#editor', {
  theme: 'snow',
  modules: {
    toolbar: [
      [{ font: [] }, { size: [] }],
      ['bold', 'italic', 'underline'],
      [{ list: 'ordered'}, { list: 'bullet' }],
      [{ align: [] }],
      ['image'],
      ['clean']
    ]
  }
});

async function load() {
  const res = await fetch("/data");
  dbData = await res.json();

  const tabList = document.getElementById("tabList");
  tabList.innerHTML = "";

  Object.keys(dbData.tabs).forEach(tab => {
    const btn = document.createElement("button");
    btn.innerText = tab;
    btn.onclick = () => selectTab(tab);
    tabList.appendChild(btn);
  });
}

function selectTab(tab) {
  currentTab = tab;
  document.getElementById("currentTab").innerText = tab;
  quill.root.innerHTML = dbData.tabs[tab].join("<hr>");
  updatePreview();
}

quill.on('text-change', updatePreview);

function updatePreview() {
  document.getElementById("previewContent").innerHTML = quill.root.innerHTML;
}

async function save() {
  if (!currentTab) return alert("Ch∆∞a ch·ªçn m·ª•c!");

  dbData.tabs[currentTab] = [quill.root.innerHTML];

  await fetch("/update", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(dbData)
  });

  alert("ƒê√£ l∆∞u!");
}

function logout() {
  window.location.href="/logout";
}

/* Upload ·∫£nh t·ª´ m√°y */
document.getElementById("imageUpload").addEventListener("change", function() {
  const file = this.files[0];
  const reader = new FileReader();
  reader.onload = function(e) {
    const range = quill.getSelection();
    quill.insertEmbed(range.index, 'image', e.target.result);
  };
  reader.readAsDataURL(file);
});

/* ·∫¢nh t·ª´ Google Drive */
function insertDriveImage() {
  const link = document.getElementById("driveLink").value;
  if (!link) return;

  const fileId = link.match(/[-\w]{25,}/);
  if (!fileId) return alert("Link kh√¥ng h·ª£p l·ªá!");

  const directLink = `https://drive.google.com/uc?export=view&id=${fileId[0]}`;
  const range = quill.getSelection();
  quill.insertEmbed(range.index, 'image', directLink);
}

load();
</script>

</body>
</html>